--[[
	Total RP 3

	Copyright 2021 Total RP 3 Development Team

	Licensed under the Apache License, Version 2.0 (the "License");
	you may not use this file except in compliance with the License.
	You may obtain a copy of the License at

	http://www.apache.org/licenses/LICENSE-2.0

	Unless required by applicable law or agreed to in writing, software
	distributed under the License is distributed on an "AS IS" BASIS,
	WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
	See the License for the specific language governing permissions and
	limitations under the License.
--]]

--
-- Companion Data Tables
--

TRP3_CompanionPetData = C_PetJournal and {} or {
	{ speciesID = 106,  itemID = 19450, spellID = 23811, creatureID = 14878 }, -- A Jubling's Tiny Home
	{ speciesID = 52,   itemID = 11023, spellID = 10685, creatureID = 7394  }, -- Ancona Chicken
	{ speciesID = 75,   itemID = 10360, spellID = 10714, creatureID = 7565  }, -- Black Kingsnake
	{ speciesID = 107,  itemID = 20371, spellID = 24696, creatureID = 15186 }, -- Blue Murloc Egg
	{ speciesID = 77,   itemID = 10361, spellID = 10716, creatureID = 7562  }, -- Brown Snake
	{ speciesID = 128,  itemID = 23083, spellID = 28871, creatureID = 16701 }, -- Captured Flame
	{ speciesID = 42,   itemID = 8491,  spellID = 10675, creatureID = 7383  }, -- Cat Carrier (Black Tabby)
	{ speciesID = 40,   itemID = 8485,  spellID = 10673, creatureID = 7385  }, -- Cat Carrier (Bombay)
	{ speciesID = 41,   itemID = 8486,  spellID = 10674, creatureID = 7384  }, -- Cat Carrier (Cornish Rex)
	{ speciesID = 43,   itemID = 8487,  spellID = 10676, creatureID = 7382  }, -- Cat Carrier (Orange Tabby)
	{ speciesID = 44,   itemID = 8490,  spellID = 10677, creatureID = 7380  }, -- Cat Carrier (Siamese)
	{ speciesID = 45,   itemID = 8488,  spellID = 10678, creatureID = 7381  }, -- Cat Carrier (Silver Tabby)
	{ speciesID = 46,   itemID = 8489,  spellID = 10679, creatureID = 7386  }, -- Cat Carrier (White Kitten)
	{ speciesID = 84,   itemID = 11110, spellID = 13548, creatureID = 7392  }, -- Chicken Egg
	{ speciesID = 55,   itemID = 10393, spellID = 10688, creatureID = 7395  }, -- Cockroach
	{ speciesID = 78,   itemID = 10392, spellID = 10717, creatureID = 7567  }, -- Crimson Snake
	{ speciesID = 56,   itemID = 10822, spellID = 10695, creatureID = 7543  }, -- Dark Whelpling
	{ speciesID = 93,   itemID = 13584, spellID = 17708, creatureID = 11326 }, -- Diablo Stone
	{ speciesID = 114,  itemID = 20769, spellID = 25162, creatureID = 15429 }, -- Disgusting Oozeling
	{ speciesID = 68,   itemID = 8500,  spellID = 10707, creatureID = 7553  }, -- Great Horned Owl
	{ speciesID = 757,  itemID = 19055, spellID = 23531, creatureID = 14755 }, -- Green Dragon Orb
	{ speciesID = 67,   itemID = 8501,  spellID = 10706, creatureID = 7555  }, -- Hawk Owl
	{ speciesID = 130,  itemID = 23713, spellID = 30156, creatureID = 17255 }, -- Hippogryph Hatchling
	{ speciesID = 95,   itemID = 15996, spellID = 19772, creatureID = 12419 }, -- Lifelike Mechanical Toad
	{ speciesID = 86,   itemID = 11826, spellID = 15049, creatureID = 9657  }, -- Lil' Smoky
	{ speciesID = 83,   itemID = 10398, spellID = 12243, creatureID = 8376  }, -- Mechanical Chicken
	{ speciesID = 39,   itemID = 4401,  spellID = 4055,  creatureID = 2671  }, -- Mechanical Squirrel Box
	{ speciesID = 1168, itemID = 20651, spellID = 25018, creatureID = 15361 }, -- Orange Murloc Egg
	{ speciesID = 92,   itemID = 13583, spellID = 17707, creatureID = 11325 }, -- Panda Collar
	{ speciesID = 47,   itemID = 8496,  spellID = 10680, creatureID = 7390  }, -- Parrot Cage (Cockatiel)
	{ speciesID = 50,   itemID = 8492,  spellID = 10683, creatureID = 7387  }, -- Parrot Cage (Green Wing Macaw)
	{ speciesID = 49,   itemID = 8494,  spellID = 10682, creatureID = 7391  }, -- Parrot Cage (Hyacinth Macaw)
	{ speciesID = 51,   itemID = 8495,  spellID = 10684, creatureID = 7389  }, -- Parrot Cage (Senegal)
	{ speciesID = 85,   itemID = 11825, spellID = 15048, creatureID = 9656  }, -- Pet Bombling
	{ speciesID = 126,  itemID = 23007, spellID = 28739, creatureID = 16548 }, -- Piglet's Collar
	{ speciesID = 121,  itemID = 22114, spellID = 27241, creatureID = 16069 }, -- Pink Murloc Egg
	{ speciesID = 124,  itemID = 22781, spellID = 28505, creatureID = 16456 }, -- Polar Bear Collar
	{ speciesID = 70,   itemID = 10394, spellID = 10709, creatureID = 14421 }, -- Prairie Dog Whistle
	{ speciesID = 72,   itemID = 8497,  spellID = 10711, creatureID = 7560  }, -- Rabbit Crate (Snowshoe)
	{ speciesID = 127,  itemID = 23015, spellID = 28740, creatureID = 16549 }, -- Rat Cage
	{ speciesID = 758,  itemID = 19054, spellID = 23530, creatureID = 14756 }, -- Red Dragon Orb
	{ speciesID = 120,  itemID = 21305, spellID = 26541, creatureID = 15705 }, -- Red Helper Box
	{ speciesID = 90,   itemID = 12529, spellID = 16450, creatureID = 10598 }, -- Smolderweb Carrier
	{ speciesID = 87,   itemID = 11474, spellID = 15067, creatureID = 9662  }, -- Sprite Darter Egg
	{ speciesID = 58,   itemID = 8499,  spellID = 10697, creatureID = 7544  }, -- Tiny Crimson Whelpling
	{ speciesID = 59,   itemID = 8498,  spellID = 10698, creatureID = 7545  }, -- Tiny Emerald Whelpling
	{ speciesID = 116,  itemID = 21277, spellID = 26010, creatureID = 15699 }, -- Tranquil Mechanical Yeti
	{ speciesID = 65,   itemID = 11026, spellID = 10704, creatureID = 7549  }, -- Tree Frog Box
	{ speciesID = 122,  itemID = 22235, spellID = 27570, creatureID = 16085 }, -- Truesilver Shafted Arrow
	{ speciesID = 125,  itemID = 23002, spellID = 28738, creatureID = 16547 }, -- Turtle Box
	{ speciesID = 1073, itemID = 22780, spellID = 28487, creatureID = 16445 }, -- White Murloc Egg
	{ speciesID = 1927, itemID = 23712, spellID = 30152, creatureID = 17254 }, -- White Tiger Cub
	{ speciesID = 64,   itemID = 11027, spellID = 10703, creatureID = 7550  }, -- Wood Frog Box
	{ speciesID = 89,   itemID = 12264, spellID = 15999, creatureID = 10259 }, -- Worg Carrier
	{ speciesID = 94,   itemID = 13582, spellID = 17709, creatureID = 11327 }, -- Zergling Leash
};

TRP3_CompanionMountData = C_MountJournal and {} or {
	{ mountID = 77,  itemID = 18243, spellID = 22719, classID = nil }, -- Black Battlestrider
	{ mountID = 122, itemID = 21176, spellID = 26656, classID = nil }, -- Black Qiraji Resonating Crystal
	{ mountID = 9,   itemID = 2411,  spellID = 470,   classID = nil }, -- Black Stallion Bridle
	{ mountID = 76,  itemID = 18247, spellID = 22718, classID = nil }, -- Black War Kodo
	{ mountID = 78,  itemID = 18244, spellID = 22720, classID = nil }, -- Black War Ram
	{ mountID = 75,  itemID = 18241, spellID = 22717, classID = nil }, -- Black War Steed Bridle
	{ mountID = 40,  itemID = 8595,  spellID = 10969, classID = nil }, -- Blue Mechanostrider
	{ mountID = 117, itemID = 21218, spellID = 25953, classID = nil }, -- Blue Qiraji Resonating Crystal
	{ mountID = 66,  itemID = 13332, spellID = 17463, classID = nil }, -- Blue Skeletal Horse
	{ mountID = 6,   itemID = 5656,  spellID = 458,   classID = nil }, -- Brown Horse Bridle
	{ mountID = 72,  itemID = 15290, spellID = 18990, classID = nil }, -- Brown Kodo
	{ mountID = 25,  itemID = 5872,  spellID = 6899,  classID = nil }, -- Brown Ram
	{ mountID = 67,  itemID = 13333, spellID = 17464, classID = nil }, -- Brown Skeletal Horse
	{ mountID = 18,  itemID = 5655,  spellID = 6648,  classID = nil }, -- Chestnut Mare Bridle
	{ mountID = 69,  itemID = 13335, spellID = 17481, classID = nil }, -- Deathcharger's Reins
	{ mountID = 71,  itemID = 15277, spellID = 18989, classID = nil }, -- Gray Kodo
	{ mountID = 21,  itemID = 5864,  spellID = 6777,  classID = nil }, -- Gray Ram
	{ mountID = 103, itemID = 18794, spellID = 23249, classID = nil }, -- Great Brown Kodo
	{ mountID = 102, itemID = 18795, spellID = 23248, classID = nil }, -- Great Gray Kodo
	{ mountID = 101, itemID = 18793, spellID = 23247, classID = nil }, -- Great White Kodo
	{ mountID = 57,  itemID = 13321, spellID = 17453, classID = nil }, -- Green Mechanostrider
	{ mountID = 120, itemID = 21323, spellID = 26056, classID = nil }, -- Green Qiraji Resonating Crystal
	{ mountID = 68,  itemID = 13334, spellID = 17465, classID = nil }, -- Green Skeletal Warhorse
	{ mountID = 82,  itemID = 18245, spellID = 22724, classID = nil }, -- Horn of the Black War Wolf
	{ mountID = 20,  itemID = 5668,  spellID = 6654,  classID = nil }, -- Horn of the Brown Wolf
	{ mountID = 19,  itemID = 5665,  spellID = 6653,  classID = nil }, -- Horn of the Dire Wolf
	{ mountID = 108, itemID = 19029, spellID = 23509, classID = nil }, -- Horn of the Frostwolf Howler
	{ mountID = 104, itemID = 18796, spellID = 23250, classID = nil }, -- Horn of the Swift Brown Wolf
	{ mountID = 106, itemID = 18798, spellID = 23252, classID = nil }, -- Horn of the Swift Gray Wolf
	{ mountID = 105, itemID = 18797, spellID = 23251, classID = nil }, -- Horn of the Swift Timber Wolf
	{ mountID = 14,  itemID = 1132,  spellID = 580,   classID = nil }, -- Horn of the Timber Wolf
	{ mountID = 11,  itemID = 2414,  spellID = 472,   classID = nil }, -- Pinto Bridle
	{ mountID = 100, itemID = 18791, spellID = 23246, classID = nil }, -- Purple Skeletal Warhorse
	{ mountID = 39,  itemID = 8563,  spellID = 10873, classID = nil }, -- Red Mechanostrider
	{ mountID = 118, itemID = 21321, spellID = 26054, classID = nil }, -- Red Qiraji Resonating Crystal
	{ mountID = 65,  itemID = 13331, spellID = 17462, classID = nil }, -- Red Skeletal Horse
	{ mountID = 80,  itemID = 18248, spellID = 22722, classID = nil }, -- Red Skeletal Warhorse
	{ mountID = 81,  itemID = 18242, spellID = 22723, classID = nil }, -- Reins of the Black War Tiger
	{ mountID = 31,  itemID = 8632,  spellID = 10789, classID = nil }, -- Reins of the Spotted Frostsaber
	{ mountID = 26,  itemID = 8631,  spellID = 8394,  classID = nil }, -- Reins of the Striped Frostsaber
	{ mountID = 34,  itemID = 8629,  spellID = 10793, classID = nil }, -- Reins of the Striped Nightsaber
	{ mountID = 87,  itemID = 18766, spellID = 23221, classID = nil }, -- Reins of the Swift Frostsaber
	{ mountID = 85,  itemID = 18767, spellID = 23219, classID = nil }, -- Reins of the Swift Mistsaber
	{ mountID = 107, itemID = 18902, spellID = 23338, classID = nil }, -- Reins of the Swift Stormsaber
	{ mountID = 55,  itemID = 13086, spellID = 17229, classID = nil }, -- Reins of the Winterspring Frostsaber
	{ mountID = 109, itemID = 19030, spellID = 23510, classID = nil }, -- Stormpike Battle Charger
	{ mountID = 84,  itemID = nil,   spellID = 23214, classID = 2   }, -- Summon Charger
	{ mountID = 83,  itemID = nil,   spellID = 23161, classID = 9   }, -- Summon Dreadsteed
	{ mountID = 17,  itemID = nil,   spellID = 5784,  classID = 9   }, -- Summon Felsteed
	{ mountID = 41,  itemID = nil,   spellID = 13819, classID = 2   }, -- Summon Warhorse
	{ mountID = 97,  itemID = 18788, spellID = 23241, classID = nil }, -- Swift Blue Raptor
	{ mountID = 94,  itemID = 18786, spellID = 23238, classID = nil }, -- Swift Brown Ram
	{ mountID = 93,  itemID = 18777, spellID = 23229, classID = nil }, -- Swift Brown Steed
	{ mountID = 95,  itemID = 18787, spellID = 23239, classID = nil }, -- Swift Gray Ram
	{ mountID = 90,  itemID = 18772, spellID = 23225, classID = nil }, -- Swift Green Mechanostrider
	{ mountID = 98,  itemID = 18789, spellID = 23242, classID = nil }, -- Swift Olive Raptor
	{ mountID = 99,  itemID = 18790, spellID = 23243, classID = nil }, -- Swift Orange Raptor
	{ mountID = 91,  itemID = 18776, spellID = 23227, classID = nil }, -- Swift Palomino
	{ mountID = 110, itemID = 19872, spellID = 24242, classID = nil }, -- Swift Razzashi Raptor
	{ mountID = 89,  itemID = 18773, spellID = 23223, classID = nil }, -- Swift White Mechanostrider
	{ mountID = 96,  itemID = 18785, spellID = 23240, classID = nil }, -- Swift White Ram
	{ mountID = 92,  itemID = 18778, spellID = 23228, classID = nil }, -- Swift White Steed
	{ mountID = 88,  itemID = 18774, spellID = 23222, classID = nil }, -- Swift Yellow Mechanostrider
	{ mountID = 111, itemID = 19902, spellID = 24252, classID = nil }, -- Swift Zulian Tiger
	{ mountID = 58,  itemID = 13322, spellID = 17454, classID = nil }, -- Unpainted Mechanostrider
	{ mountID = 79,  itemID = 18246, spellID = 22721, classID = nil }, -- Whistle of the Black War Raptor
	{ mountID = 27,  itemID = 8588,  spellID = 8395,  classID = nil }, -- Whistle of the Emerald Raptor
	{ mountID = 36,  itemID = 8591,  spellID = 10796, classID = nil }, -- Whistle of the Turquoise Raptor
	{ mountID = 38,  itemID = 8592,  spellID = 10799, classID = nil }, -- Whistle of the Violet Raptor
	{ mountID = 24,  itemID = 5873,  spellID = 6898,  classID = nil }, -- White Ram
	{ mountID = 119, itemID = 21324, spellID = 26055, classID = nil }, -- Yellow Qiraji Resonating Crystal
};

--
-- Data Initialization
--

do
	local function FilterUnknownRecords(data)
		if data.itemID and not C_Item.DoesItemExistByID(data.itemID) then
			return false;  -- Item not known to client.
		elseif data.spellID and not C_Spell.DoesSpellExist(data.spellID) then
			return false;  -- Spell not known to client.
		else
			return true;
		end
	end

	TRP3_CompanionPetData = tFilter(TRP3_CompanionPetData, FilterUnknownRecords, true);
	TRP3_CompanionMountData = tFilter(TRP3_CompanionMountData, FilterUnknownRecords, true);
end

--
-- Resource Functions
--

do
	local companionPetsByCreatureID = {};
	local companionPetsBySpeciesID = {};
	local companionPetsBySpellID = {};
	local companionMountsByMountID = {};
	local companionMountsBySpellID = {};
	local currentSummonedMountID = IsMounted();
	local previousMountedStatus = nil;
	local rescanSummonedMountID = true;

	do
		local function RequestPreloadData(data)
			if data.itemID then
				C_Item.RequestLoadItemDataByID(data.itemID);
			end

			if data.spellID then
				C_Spell.RequestLoadSpellData(data.spellID);
			end
		end

		for _, petInfo in ipairs(TRP3_CompanionPetData) do
			companionPetsByCreatureID[petInfo.creatureID] = petInfo;
			companionPetsBySpeciesID[petInfo.speciesID] = petInfo;
			companionPetsBySpellID[petInfo.spellID] = petInfo;
			RequestPreloadData(petInfo);
		end

		for _, mountInfo in ipairs(TRP3_CompanionMountData) do
			companionMountsByMountID[mountInfo.mountID] = mountInfo;
			companionMountsBySpellID[mountInfo.spellID] = mountInfo;
			RequestPreloadData(mountInfo);
		end
	end

	function TRP3_API.utils.resources.GetNumPets()
		return #TRP3_CompanionPetData;
	end

	function TRP3_API.utils.resources.GetPetInfoByPetID(petID)
		-- The pet ID as returned by GetPetInfoByIndex is a stringified form
		-- of the species ID.

		local speciesID = tonumber(petID);
		local petInfo = companionPetsBySpeciesID[speciesID];

		if not petInfo then
			return nil;
		end

		local customName = C_Item.GetItemNameByID(petInfo.itemID);
		local level = 1;
		local xp = 1;
		local maxXp = 1;
		local displayID = nil;
		local isFavorite = false;
		local name = customName;
		local icon = C_Item.GetItemIconByID(petInfo.itemID);
		local petType = nil;
		local creatureID = petInfo.creatureID;
		local sourceText = nil;
		local description = GetSpellDescription(petInfo.spellID);
		local isWild = false;
		local canBattle = false;
		local tradable = false;
		local unique = false;
		local obtainable = true;

		return speciesID, customName, level, xp, maxXp, displayID, isFavorite, name, icon, petType, creatureID, sourceText, description, isWild, canBattle, tradable, unique, obtainable;
	end

	function TRP3_API.utils.resources.GetPetInfoByIndex(petIndex)
		local petInfo = TRP3_CompanionPetData[petIndex];

		if not petInfo then
			return;
		end

		local petID = tostring(petInfo.speciesID);
		local speciesID = petInfo.speciesID;
		local owned = true;
		local customName = C_Item.GetItemNameByID(petInfo.itemID);
		local level = 1;
		local favorite = false;
		local isRevoked = false;
		local speciesName = customName;
		local icon = C_Item.GetItemIconByID(petInfo.itemID);
		local petType = nil;
		local creatureID = petInfo.creatureID;
		local tooltip = nil;
		local description = GetSpellDescription(petInfo.spellID);
		local isWild = false;
		local canBattle = false;
		local isTradeable = false;
		local isUnique = false;
		local obtainable = true;

		return petID, speciesID, owned, customName, level, favorite, isRevoked, speciesName, icon, petType, creatureID, tooltip, description, isWild, canBattle, isTradeable, isUnique, obtainable;
	end

	function TRP3_API.utils.resources.GetPetSpeciesBySpellID(spellID)
		-- Extension API that doesn't correlate to anything in non-Classic clients.
		local petInfo = companionPetsBySpellID[spellID];

		if petInfo then
			return petInfo.speciesID;
		end
	end

	function TRP3_API.utils.resources.GetPetNameByCreatureID(creatureID)
		-- Extension API that doesn't correlate to anything in non-Classic clients.
		local petInfo = companionPetsByCreatureID[creatureID];

		if petInfo then
			return C_Item.GetItemNameByID(petInfo.itemID);
		end
	end

	function TRP3_API.utils.resources.IsPetCreature(creatureID)
		-- Extension API that doesn't correlate to anything in non-Classic clients.
		return companionPetsByCreatureID[creatureID] ~= nil;
	end

	function TRP3_API.utils.resources.GetMountIDs()
		local mountIDs = {};
		local playerClassID = select(2, UnitClassBase("player"));

		for _, mountInfo in ipairs(TRP3_CompanionMountData) do
			if mountInfo.classID == nil or mountInfo.classID == playerClassID then
				table.insert(mountIDs, mountInfo.mountID);
			end
		end

		return mountIDs;
	end

	function TRP3_API.utils.resources.GetMountInfoByID(mountID)
		local mountInfo = companionMountsByMountID[mountID];

		if not mountInfo then
			return;
		end

		local name = (mountInfo.itemID ~= nil) and C_Item.GetItemNameByID(mountInfo.itemID) or GetSpellInfo(mountInfo.spellID);
		local spellID = mountInfo.spellID;
		local icon = (mountInfo.itemID ~= nil) and C_Item.GetItemIconByID(mountInfo.itemID) or GetSpellTexture(mountInfo.spellID);
		local isActive = TRP3_API.utils.resources.GetSummonedMountID() == mountInfo.mountID;
		local isUsable = true;
		local sourceType = nil;
		local isFavorite = false;
		local isFactionSpecific = false;
		local faction = nil;
		local isCollected = (mountInfo.classID == nil or mountInfo.classID == select(2, UnitClassBase("player")));
		local shouldHideOnChar = not isCollected;

		return name, spellID, icon, isActive, isUsable, sourceType, isFavorite, isFactionSpecific, faction, shouldHideOnChar, isCollected, mountID;
	end

	function TRP3_API.utils.resources.GetMountInfoExtraByID(mountID)
		local mountInfo = companionMountsByMountID[mountID];

		if not mountInfo then
			return;
		end

		local creatureDisplayInfoID = nil;
		local description = GetSpellDescription(mountInfo.spellID);
		local source = nil;
		local isSelfMount = false;
		local mountTypeID = nil;
		local uiModelSceneID = nil;
		local animID = nil;
		local spellVisualKitID = nil;
		local disablePlayerMountPreview = false;

		return creatureDisplayInfoID, description, source, isSelfMount, mountTypeID, uiModelSceneID, animID, spellVisualKitID, disablePlayerMountPreview;
	end

	function TRP3_API.utils.resources.GetSummonedMountID()
		-- Extension API that doesn't correlate to anything in non-Classic clients.

		if not rescanSummonedMountID then
			return currentSummonedMountID;
		end

		local spellID;
		local auraIndex = 0;

		repeat
			auraIndex = auraIndex + 1;
			spellID = select(10, UnitAura("player", auraIndex, "HELPFUL|PLAYER|CANCELABLE"));
		until spellID == nil or companionMountsBySpellID[spellID] ~= nil;

		local mountInfo = companionMountsBySpellID[spellID];

		currentSummonedMountID = mountInfo and mountInfo.mountID or nil;
		rescanSummonedMountID = false;

		return currentSummonedMountID;
	end

	-- Finding the summoned mount is hard work on Classic so we only rescan
	-- when unit auras change for the player.

	TRP3_API.Ellyb.GameEvents.registerCallback("UNIT_AURA", function(unit)
		local currentMountedStatus = IsMounted();
		rescanSummonedMountID = rescanSummonedMountID or (unit == "player") and (previousMountedStatus ~= currentMountedStatus);
		previousMountedStatus = currentMountedStatus;
	end);
end
